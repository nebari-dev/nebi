name: Deploy to Fly.io

on:
  workflow_dispatch:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@fc53c09e1bc3be6f54706524e3b82c4f462f77be # 1.5

      - name: Create app if it doesn't exist
        run: |
          if ! flyctl status --app nebi 2>/dev/null; then
            echo "Creating app..."
            flyctl apps create nebi
          else
            echo "App already exists"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Create volume if it doesn't exist
        run: |
          if ! flyctl volumes list --app nebi 2>/dev/null | grep -q nebi_data; then
            echo "Creating volume..."
            flyctl volumes create nebi_data --region sjc --size 1 --yes --app nebi
          else
            echo "Volume already exists"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Set Fly.io secrets
        run: |
          flyctl secrets set \
            NEBI_AUTH_JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            ADMIN_USERNAME="${{ secrets.ADMIN_USERNAME }}" \
            ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}" \
            --app nebi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
