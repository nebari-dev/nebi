services:
  # Traefik - Reverse Proxy with automatic HTTPS
  traefik:
    image: traefik:v3.2
    container_name: nebi-traefik
    command:
      # API and dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true"

      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_certs:/letsencrypt
    networks:
      - nebi-network
    restart: unless-stopped

  # PostgreSQL 18 - Latest version
  postgres:
    image: postgres:18
    container_name: nebi-postgres
    environment:
      POSTGRES_DB: nebi
      POSTGRES_USER: nebi
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nebi"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nebi-network

  # Valkey 9.0 - Latest version (Redis replacement)
  valkey:
    image: valkey/valkey:9.0.0
    container_name: nebi-valkey
    ports:
      - "6379:6379"
    volumes:
      - valkey_data:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nebi-network

  # Nebi API + Worker (both mode)
  nebi-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nebi-api
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.nebi.rule=Host(`${NEBI_DOMAIN:-nebi.localhost}`)"
      - "traefik.http.routers.nebi.entrypoints=websecure"
      - "traefik.http.routers.nebi.tls.certresolver=letsencrypt"
      # Service
      - "traefik.http.services.nebi.loadbalancer.server.port=8460"
    environment:
      # Database configuration
      NEBI_DATABASE_DRIVER: postgres
      NEBI_DATABASE_DSN: "postgres://nebi:${POSTGRES_PASSWORD}@postgres:5432/nebi?sslmode=disable"
      NEBI_DATABASE_MAX_IDLE_CONNS: 10
      NEBI_DATABASE_MAX_OPEN_CONNS: 100
      NEBI_DATABASE_CONN_MAX_LIFETIME: 60

      # Queue configuration
      NEBI_QUEUE_TYPE: valkey
      NEBI_QUEUE_VALKEY_ADDR: "valkey:6379"

      # Logging
      NEBI_LOG_LEVEL: debug
      NEBI_LOG_FORMAT: text

      # Server configuration
      NEBI_SERVER_PORT: 8460
      NEBI_SERVER_MODE: development

      # Admin user (created on first startup)
      ADMIN_USERNAME: ${ADMIN_USERNAME:?ADMIN_USERNAME is required}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@nebi.local}
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
      traefik:
        condition: service_started
    command: ["/app/nebi", "--mode=both"]
    volumes:
      - ./data/environments:/app/data/environments
    networks:
      - nebi-network

  # Nebi Worker (worker-only mode) - Additional workers
  nebi-worker-1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nebi-worker-1
    environment:
      # Database configuration
      NEBI_DATABASE_DRIVER: postgres
      NEBI_DATABASE_DSN: "postgres://nebi:${POSTGRES_PASSWORD}@postgres:5432/nebi?sslmode=disable"
      NEBI_DATABASE_MAX_IDLE_CONNS: 10
      NEBI_DATABASE_MAX_OPEN_CONNS: 100
      NEBI_DATABASE_CONN_MAX_LIFETIME: 60

      # Queue configuration
      NEBI_QUEUE_TYPE: valkey
      NEBI_QUEUE_VALKEY_ADDR: "valkey:6379"

      # Logging
      NEBI_LOG_LEVEL: debug
      NEBI_LOG_FORMAT: text
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
      nebi-api:
        condition: service_started
    command: ["/app/nebi", "--mode=worker"]
    volumes:
      - ./data/environments:/app/data/environments
    networks:
      - nebi-network

  nebi-worker-2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nebi-worker-2
    environment:
      # Database configuration
      NEBI_DATABASE_DRIVER: postgres
      NEBI_DATABASE_DSN: "postgres://nebi:${POSTGRES_PASSWORD}@postgres:5432/nebi?sslmode=disable"
      NEBI_DATABASE_MAX_IDLE_CONNS: 10
      NEBI_DATABASE_MAX_OPEN_CONNS: 100
      NEBI_DATABASE_CONN_MAX_LIFETIME: 60

      # Queue configuration
      NEBI_QUEUE_TYPE: valkey
      NEBI_QUEUE_VALKEY_ADDR: "valkey:6379"

      # Logging
      NEBI_LOG_LEVEL: debug
      NEBI_LOG_FORMAT: text
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
      nebi-api:
        condition: service_started
    command: ["/app/nebi", "--mode=worker"]
    volumes:
      - ./data/environments:/app/data/environments
    networks:
      - nebi-network

volumes:
  postgres_data:
    driver: local
  valkey_data:
    driver: local
  traefik_certs:
    driver: local

networks:
  nebi-network:
    driver: bridge
